# 버그 수정 보고서 - 2025년 11월 6일

## 문제 1: 영업이력에서 리타겟팅으로 옮길 때 인스타그램 아이디 필드 매핑 오류

### 문제 상황
- 영업이력에서 리타겟팅으로 옮길 때 인스타그램 아이디가 instagram 필드에 들어가야 하는데
- 실제로는 company_name과 customer_name 필드에 들어가고 있었음

### 원인
- 과거 코드로 생성된 잘못된 데이터가 데이터베이스에 저장되어 있었음
- 예시:
  ```
  company_name: "iida.kashi_ten" (인스타그램 아이디)
  customer_name: "iida.kashi_ten" (인스타그램 아이디)
  instagram: "" (비어있음)
  ```

### 해결 방법

#### 1. 데이터베이스 수정
잘못 저장된 데이터 3건을 수정:
```sql
-- 상호/고객명에 잘못 들어간 인스타그램 아이디를 '未設定'으로 변경
UPDATE retargeting_customers 
SET company_name = '未設定', customer_name = '未設定' 
WHERE company_name IN ('iida.kashi_ten', 'motomin.fitness', 'y.one.plus.erw') 
AND sales_tracking_id IS NOT NULL;

-- instagram 필드에 올바른 값 저장
UPDATE retargeting_customers rc 
SET instagram = st.account_id 
FROM sales_tracking st 
WHERE rc.sales_tracking_id = st.id 
AND rc.company_name = '未設定' 
AND rc.customer_name = '未設定' 
AND st.account_id IS NOT NULL;
```

#### 2. 수정 결과
```
수정 전:
- company_name: "iida.kashi_ten"
- customer_name: "iida.kashi_ten"  
- instagram: ""

수정 후:
- company_name: "未設定"
- customer_name: "未設定"
- instagram: "iida.kashi_ten" ✅
```

### 현재 코드 검증
서버 코드(`cursor/server/src/routes/salesTracking.ts`)는 이미 올바르게 작성되어 있음:
- `account_id`는 `instagram` 필드에만 저장
- `company_name`과 `customer_name`은 각각의 필드만 사용

### 재발 방지
- 현재 코드는 올바르게 작성되어 있으므로 새로운 데이터는 정상적으로 저장됨
- 과거 데이터는 모두 수정 완료

---

## 문제 2: 검색 시 일치하지 않는 결과 표시

### 문제 상황
- 검색 시 부분 일치로 인해 정확하지 않은 결과가 많이 표시됨
- 예: "charmy"로 검색 시 "charmy.1964_official", "charmy_nail" 등 모두 표시

### 원인
- 기존 검색 로직이 `ILIKE %keyword%`로 부분 일치만 사용
- 정확 일치나 시작 일치를 우선하지 않음

### 해결 방법

#### 1. 검색 우선순위 적용
검색 결과를 3단계 우선순위로 정렬:
1. **정확 일치** (우선순위 1): 검색어와 정확히 일치
2. **시작 일치** (우선순위 2): 검색어로 시작
3. **부분 일치** (우선순위 3): 검색어를 포함

#### 2. 코드 수정
`cursor/server/src/routes/globalSearch.ts` 수정:

```typescript
// 변경 전: 부분 일치만 사용
WHERE company_name ILIKE $1 OR customer_name ILIKE $1
LIMIT 10

// 변경 후: 우선순위 정렬 추가
SELECT ..., 
  CASE
    WHEN company_name = $2 OR customer_name = $2 THEN 1  -- 정확 일치
    WHEN company_name ILIKE $3 OR customer_name ILIKE $3 THEN 2  -- 시작 일치
    ELSE 3  -- 부분 일치
  END as match_priority
FROM ...
WHERE company_name ILIKE $1 OR customer_name ILIKE $1
ORDER BY match_priority, company_name
LIMIT 10
```

#### 3. 적용 범위
- 고객관리 검색
- 리타겟팅 검색
- 영업이력 검색

### 효과
- 정확한 검색어가 먼저 표시됨
- 부정확한 결과는 하단에 표시됨
- 검색 경험 개선

---

## 배포

### 수정 사항 커밋
```bash
git add cursor/server/src/routes/globalSearch.ts cursor/server/dist/
git commit -m "[Fix] 1. 리타겟팅 데이터 수정 2. 검색 정확도 개선"
git push origin main
```

### 배포 확인
- Railway가 자동으로 서버 배포 (1-2분 소요)
- 변경 사항은 즉시 적용됨

### 확인 방법
1. 영업이력에서 리타겟팅으로 옮기기
   - 인스타그램 아이디가 instagram 필드에 저장되는지 확인
   - company_name과 customer_name이 올바른 값으로 저장되는지 확인

2. 검색 기능 테스트
   - 정확한 검색어가 먼저 표시되는지 확인
   - 부분 일치 결과가 하단에 표시되는지 확인

---

## 요약

### 수정 내용
1. ✅ 잘못 저장된 리타겟팅 데이터 3건 수정
2. ✅ 검색 정확도 개선 (정확 일치 > 시작 일치 > 부분 일치)

### 재발 방지
- 현재 코드는 올바르게 작성되어 있음
- 과거 데이터는 모두 수정 완료
- 새로운 데이터는 정상적으로 저장됨

### 다음 단계
- Railway 배포 자동 완료 대기 (1-2분)
- 웹사이트에서 기능 확인

